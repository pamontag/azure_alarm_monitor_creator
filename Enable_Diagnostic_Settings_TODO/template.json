{
	"$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"vmName": {
			"type": "string",
			"metadata": {
				"description": "The name of the VM"
			}
    	},
		"storageAccountName": {
			"type": "SecureString",
			"metadata": {
			  "description": "ResourceID of the Storage Account in which resource logs should be saved."
			}
		}
	},
	"variables": {
        "vmResourceId": "[resourceId('Microsoft.Compute/virtualMachines',parameters('vmName'))]",
        "storageAccountResourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
    },
	"resources": 
    [
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-07-01",
            "name": "[parameters('vmName')]",
            "location": "[resourceGroup().location]",
            "identity": {
                "type": "SystemAssigned"
            },
            "resources": 
            [
                {
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "name": "[concat(parameters('vmName'), '/', 'WADExtensionSetup')]",
                    "apiVersion": "2017-12-01",
                    "location": "[resourceGroup().location]",
                    "dependsOn": [
                        "[variables('vmResourceId')]"
                    ],
                    "properties": {
                        "publisher": "Microsoft.ManagedIdentity",
                        "type": "ManagedIdentityExtensionForWindows",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "port": 50342
                        }
                    }
                },
                {
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "name": "[concat(parameters('vmName'), '/', 'Microsoft.Insights.VMDiagnosticsSettings')]",
                    "apiVersion": "2019-07-01",
                    "location": "[resourceGroup().location]",
                    "dependsOn": [
                        "[variables('vmResourceId')]"
                    ],
                    "properties": {                
                        "publisher": "Microsoft.Azure.Diagnostics",
                        "type": "IaaSDiagnostics",
                        "typeHandlerVersion": "1.5",
                        "autoUpgradeMinorVersion": true,
                        "settings": 
                        {
                            "WadCfg": 
                            {
                                "DiagnosticMonitorConfiguration": 
                                {
                                    "overallQuotaInMB": 4096,
                                    "PerformanceCounters": {
                                        "scheduledTransferPeriod": "PT1M",
                                        "sinks": "AzMonSink",
                                        "PerformanceCounterConfiguration": [
                                            {
                                                "counterSpecifier": "\\Memory\\Available MBytes",
                                                "sampleRate": "PT60S",
                                                "unit": "MBytes"
                                            },
                                            {
                                                "counterSpecifier": "\\LogicalDisk\\% Free Space",
                                                "sampleRate": "PT60S",
                                                "unit": "Percent"
                                            },
                                            {
                                                "counterSpecifier": "\\Processor Information\\% Processor Time",
                                                "sampleRate": "PT60S",
                                                "unit": "Percent"
                                            }
                                        ]                    
                                    },
                                    "SinksConfig": {
                                        "Sink": [
                                            {
                                                "name" : "AzMonSink",
                                                "AzureMonitor" : {}
                                            }
                                        ]
                                    }
                                },
                                "StorageAccount": "[parameters('storageAccountName')]"
                            },
                            "protectedSettings": 
                            {
                                "storageAccountName": "[parameters('storageAccountName')]",
                                "storageAccountKey": "[listKeys(variables('storageAccountResourceId'),'2019-04-01').keys[0].value]",
                                "storageAccountEndPoint": "https://core.windows.net/"
                            }
                        }
                    }
                }
            ]
            
        }        
    ]
}